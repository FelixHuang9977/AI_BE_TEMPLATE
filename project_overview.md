# Project Overview: AI Diagnosis Backend Service (`ai_diagbe`)

## 1. Introduction
`ai_diagbe` is a RESTful API service developed for an AI diagnosis system. It is built using Python 3.8+ and the FastAPI framework. The service is designed to manage "assemble tests" (running external diagnostic scripts) and manage "FIM" (Fault Isolation Map) states. It is a stateless service that relies on the file system for persistence.

## 2. Tech Stack
-   **Language:** Python 3.8+
-   **Web Framework:** FastAPI
-   **ASGI Server:** Uvicorn
-   **HTTP Client:** Requests, HTTPX (likely for testing or internal calls)
-   **Testing:** Pytest, FastAPI TestClient
-   **Data Validation:** Pydantic

## 3. Project Structure
```text
.
├── app/
│   ├── main.py       # FastAPI application entry point, API routes, and models
│   └── utils.py      # Utility functions for file I/O, process management, and script execution
├── scripts/          # Directory for executable scripts and temporary data storage
├── tests/            # Test suite (integration and mock tests)
├── .gitignore        # Git ignore rules
├── LICENSE.md        # License file
├── Makefile          # Build/Task automation
├── README.md         # Project documentation
├── pyproject.toml    # Project metadata and dependencies
├── requirements.txt  # Python dependencies
└── ai_diagbe.service # Systemd service file for deployment
```

## 4. Key Functionality

### 4.1. Assemble Test Management
The service allows users to start, monitor, and manage diagnostic tests ("assemble tests").
-   **Start Test (`POST /api/v1/assemble_test`):** Triggers an external script (`assemble_test.py`, `.bat`, or `.sh`) in a background process. It creates a unique `test_id` (if not provided) and returns it immediately.
-   **Get Status (`GET /api/v1/assemble_test/{test_id}`):** Checks the status of a specific test by reading a result file (`.tmp.result_assemble_test_{test_id}.txt`) generated by the script.
-   **List Tests (`GET /api/v1/assemble_test`):** Lists all active/recent tests by scanning for PID files (`.tmp.{test_id}.pid`).
-   **Delete Test (`DELETE /api/v1/assemble_test/{test_id}`):** Stops the running process (if active), deletes the PID file, and archives the result file.
-   **Cleanup (`POST /api/v1/assemble_test_clear_old_result`):** Removes old result and PID files based on a specified age (in days).

### 4.2. FIM State Management
The service provides a CRUD interface for FIM states, which are stored as JSON files.
-   **Data Model:** FIM states are associated with a `rack_sn` (Rack Serial Number) and a `test_round_id`.
-   **Storage:** Data is saved in `scripts/` as `fim_state_{rack_sn}_{test_round_id}.json`.
-   **Endpoints:**
    -   `GET /api/v1/fim_state`: Retrieve all FIM states, grouped by rack.
    -   `GET /api/v1/fim_state/{rack_sn}`: Retrieve all states for a specific rack.
    -   `GET /api/v1/fim_state/{rack_sn}/{test_round_id}`: Retrieve a specific state.
    -   `POST /api/v1/fim_state/{rack_sn}/{test_round_id}`: Create or update a FIM state.
    -   `DELETE /api/v1/fim_state/{rack_sn}/{test_round_id}`: Delete a specific state.

## 5. Implementation Details

### `app/main.py`
-   Defines the `FastAPI` app.
-   Implements all API routes.
-   Uses Pydantic models for request/response validation.
-   Delegates logic to `app.utils`.
-   Handles background task dispatching.

### `app/utils.py`
-   **`find_assemble_script(base_dir)`:** Locates the execution script with priority: `.py` -> `.bat` (Windows) -> `.sh`.
-   **`run_assemble_test_process(...)`:** Spawns the subprocess in a detached mode (Windows `start` or Unix `setsid`/`subprocess`). Writes the PID to a file.
-   **`get_scripts_dir()`:** Resolves the `scripts/` directory path.
-   **`get_all_fim_states(...)`, `get_fim_states_by_rack(...)`, etc.:** Handles parsing and reading/writing of JSON state files.
-   **`delete_assemble_test(...)`:** Handles process killing and file cleanup.

## 6. Testing
The project includes a comprehensive test suite in `tests/`:
-   **Mock Tests:** `test_mock_*.py` files likely test the API logic using mocks for file I/O and subprocesses.
-   **Real Integration Tests:** `test_real_assemble_test.py` and `test_real_fim_state.py` verify the system against actual file system operations and subprocess execution.
-   **Verification Scripts:** `verify_api.py` and `verify_non_blocking.py` are standalone scripts for manual or specific verification scenarios.

## 7. Deployment
-   The service can be run manually using `python -m app.main` or `uvicorn`.
-   A `systemd` service file (`ai_diagbe.service`) is provided for Linux deployment.
-   It listens on port 9000 by default.
